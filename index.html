<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chess vs Stockfish</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.css"
  />
  <style>
    body {
      background: #222;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    #controls {
      margin-bottom: 10px;
    }
    #board {
      margin: 20px auto;
      width: 400px;
    }
    button, select {
      margin: 5px;
      padding: 5px 10px;
      font-size: 16px;
    }
    #history {
      margin-top: 10px;
      white-space: pre-wrap;
      min-height: 50px;
      background: #333;
      padding: 10px;
      border-radius: 5px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>Chess vs Stockfish</h2>

  <div id="controls">
    <label>üéØ Difficulty:
      <select id="difficulty">
        <option value="5">Easy</option>
        <option value="10" selected>Medium</option>
        <option value="15">Hard</option>
      </select>
    </label>

    <label>‚è± Timer (minutes):
      <select id="timer">
        <option value="0">None</option>
        <option value="1">1</option>
        <option value="3" selected>3</option>
        <option value="5">5</option>
      </select>
    </label>

    <label>üé≤ Color:
      <select id="color">
        <option value="w">White</option>
        <option value="b">Black</option>
        <option value="random" selected>Random</option>
      </select>
    </label>

    <button id="startBtn">‚ñ∂ Start Game</button>
    <button id="exportBtn" style="display:none;">‚¨á Export PGN</button>
  </div>

  <div id="players" style="display:none;">
    <div>‚ôô White Time: <span id="time-w">--:--</span></div>
    <div>‚ôü Black Time: <span id="time-b">--:--</span></div>
  </div>

  <div id="board" style="display:none;"></div>

  <h3>Move History</h3>
  <div id="history"></div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@0.12.0/chess.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard.min.js"></script>

  <script>
    let board, game, engine;
    let playerColor = 'w';
    let clocks = { w: 0, b: 0 }, timerInterval;

    function displayTime(ms) {
      if (ms <= 0) return "00:00";
      const s = Math.floor(ms / 1000);
      return `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      startGame();
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('exportBtn').style.display = 'inline-block';
      document.getElementById('players').style.display = 'block';
      document.getElementById('board').style.display = 'block';
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      exportPGN();
    });

    function startGame() {
      clearInterval(timerInterval);
      game = new Chess();

      // Choose color
      const colorChoice = document.getElementById("color").value;
      if (colorChoice === "random") {
        playerColor = Math.random() < 0.5 ? 'w' : 'b';
      } else {
        playerColor = colorChoice;
      }

      board = Chessboard('board', {
        draggable: true,
        position: 'start',
        orientation: playerColor === 'w' ? 'white' : 'black',
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
        onDrop: onDrop,
      });

      // Timers
      const min = parseInt(document.getElementById('timer').value);
      clocks.w = clocks.b = min * 60 * 1000;
      document.getElementById('time-w').textContent = displayTime(clocks.w);
      document.getElementById('time-b').textContent = displayTime(clocks.b);
      if (min > 0) timerInterval = setInterval(runClock, 200);

      // Engine
      if (engine) engine.terminate();
      engine = new Worker('https://cdn.jsdelivr.net/npm/stockfish@16.0.0/stockfish.js');
      engine.postMessage('uci');

      engine.onmessage = e => {
        const line = e.data;
        if (line.startsWith('bestmove')) {
          const move = line.split(' ')[1];
          if (move === '(none)') return; // no moves possible

          game.move({ from: move.slice(0, 2), to: move.slice(2, 4), promotion: 'q' });
          board.position(game.fen());
          updateHistory();

          if (game.game_over()) {
            alert("Game Over!");
            clearInterval(timerInterval);
          }
        }
      };

      document.getElementById('history').textContent = '';

      // If AI starts
      if (playerColor === 'b') {
        engine.postMessage(`position fen ${game.fen()}`);
        engine.postMessage(`go depth ${document.getElementById('difficulty').value}`);
      }
    }

    function runClock() {
      const turn = game.turn();
      if (clocks[turn] <= 0) {
        clearInterval(timerInterval);
        alert(`${turn === 'w' ? 'White' : 'Black'} ran out of time!`);
        return;
      }
      clocks[turn] -= 200;
      document.getElementById('time-' + turn).textContent = displayTime(clocks[turn]);
    }

    function onDrop(source, target) {
      if (game.turn() !== playerColor) return 'snapback';

      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (!move) return 'snapback';

      board.position(game.fen());
      updateHistory();

      if (game.game_over()) {
        alert("Game Over!");
        clearInterval(timerInterval);
        return;
      }

      engine.postMessage(`position fen ${game.fen()}`);
      engine.postMessage(`go depth ${document.getElementById('difficulty').value}`);
    }

    function updateHistory() {
      const moves = game.history();
      let text = '';
      for (let i = 0; i < moves.length; i++) {
        if (i % 2 === 0) text += `${Math.floor(i / 2) + 1}. `;
        text += moves[i] + ' ';
      }
      document.getElementById('history').textContent = text.trim();
    }

    function exportPGN() {
      const pgn = game.pgn({ max_width: 0 });
      const blob = new Blob([pgn], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'game.pgn';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
